<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>תשאל את מיכל - צ'אט</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --olive-dark: #3d3d26;
            --olive-mid: #5c6b3c;
            --olive-light: #7a8b52;
            --olive-pale: #f0f2e8;
            --bg: #f4f5f0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #3d3d26, #4a4a2e, #5c6b3c);
            color: white;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            z-index: 10;
            flex-shrink: 0;
        }
        /* Mini Michal SVG in header */
        .mini-michal { width: 38px; height: 44px; flex-shrink: 0; }
        .header-text h1 { font-size: 15px; font-weight: 600; line-height: 1.2; }
        .header-text small { font-size: 11px; opacity: 0.7; }
        .header-actions { margin-right: auto; display: flex; align-items: center; gap: 8px; }
        .quota-badge {
            background: rgba(255,255,255,0.15);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        .header-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 32px; height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .header-btn:hover { background: rgba(255,255,255,0.2); }

        /* === MICHAL CHARACTER AREA === */
        .michal-area {
            background: linear-gradient(180deg, rgba(92,107,60,0.06) 0%, transparent 100%);
            padding: 14px 0 6px;
            text-align: center;
            flex-shrink: 0;
            transition: all 0.4s ease;
        }
        .michal-area.compact { padding: 6px 0 2px; }
        .michal-char {
            width: 100px; height: 120px;
            margin: 0 auto;
            transition: all 0.4s ease;
        }
        .michal-area.compact .michal-char { width: 55px; height: 66px; }
        .michal-char svg { width: 100%; height: 100%; }

        /* Animations */
        .char-body { animation: breathe 3s ease-in-out infinite; transform-origin: center bottom; }
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.015) translateY(-0.5px); }
        }
        .char-body.thinking { animation: thinkBounce 0.6s ease-in-out infinite; }
        @keyframes thinkBounce {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-3px) rotate(-1.5deg); }
            75% { transform: translateY(-3px) rotate(1.5deg); }
        }
        .char-body.happy .mouth-smile { d: path("M64 105 Q75 118 86 105"); }
        .eye-lid { animation: blink 3.5s ease-in-out infinite; transform-origin: center; }
        @keyframes blink {
            0%, 42%, 46%, 100% { transform: scaleY(0); }
            44% { transform: scaleY(1); }
        }
        .pupil { animation: look 5s ease-in-out infinite; }
        @keyframes look {
            0%, 40%, 100% { transform: translate(0, 0); }
            20% { transform: translate(1.5px, -0.5px); }
            60% { transform: translate(-1.5px, 0.5px); }
        }

        .michal-status {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            min-height: 18px;
            transition: all 0.3s;
        }

        /* === MESSAGES === */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .msg {
            max-width: 82%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.65;
            font-size: 14px;
            white-space: pre-wrap;
            animation: msgIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            word-wrap: break-word;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(10px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .msg.user {
            align-self: flex-start;
            background: linear-gradient(135deg, var(--olive-mid), var(--olive-light));
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(92,107,60,0.2);
        }
        .msg.bot {
            align-self: flex-end;
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .msg.bot .sources {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
            font-size: 11px;
            color: #aaa;
            line-height: 1.5;
        }
        .msg.system {
            align-self: center;
            background: linear-gradient(135deg, #fff8e1, #fff3cd);
            color: #8d6e00;
            font-size: 12px;
            max-width: 90%;
            text-align: center;
            border-radius: 20px;
            padding: 8px 18px;
        }
        .msg.system.success {
            background: linear-gradient(135deg, #f0f2e8, #e0e4d4);
            color: var(--olive-mid);
        }

        /* === INPUT AREA === */
        .input-area {
            padding: 10px 14px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: white;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-shrink: 0;
        }
        .input-wrap {
            flex: 1;
        }
        .input-wrap textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e4e4dc;
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            direction: rtl;
            resize: none;
            max-height: 100px;
            min-height: 42px;
            line-height: 1.4;
            transition: border-color 0.2s;
        }
        .input-wrap textarea:focus { border-color: var(--olive-light); }
        .action-btn {
            width: 42px; height: 42px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .send-btn {
            background: linear-gradient(135deg, var(--olive-mid), var(--olive-light));
            color: white;
            box-shadow: 0 3px 12px rgba(92,107,60,0.3);
        }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .upload-btn {
            background: var(--olive-pale);
            color: var(--olive-mid);
        }
        .upload-btn:hover { background: #e4e8d8; }

        .messages::-webkit-scrollbar { width: 4px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        @media (max-width: 600px) {
            .msg { max-width: 88%; }
            .quota-badge { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <svg class="mini-michal" viewBox="0 0 150 180" fill="none">
            <g>
                <ellipse cx="75" cy="82" rx="52" ry="50" fill="#5a3825"/>
                <rect x="63" y="125" width="24" height="14" rx="4" fill="#fdd0a8"/>
                <path d="M40 138 Q42 132 63 132 L87 132 Q108 132 110 138 L115 170 Q115 178 105 178 L45 178 Q35 178 35 170 Z" fill="#5c6b3c"/>
                <path d="M63 132 L75 145 L87 132" fill="#4a5a30"/>
                <ellipse cx="75" cy="88" rx="42" ry="40" fill="#fdd0a8"/>
                <ellipse cx="60" cy="85" rx="8" ry="9" fill="white"/>
                <ellipse cx="60" cy="85" rx="5.5" ry="6" fill="#3d2b1f"/>
                <circle cx="61" cy="84" r="2.5" fill="black"/>
                <circle cx="63" cy="82" r="1.5" fill="white"/>
                <ellipse cx="90" cy="85" rx="8" ry="9" fill="white"/>
                <ellipse cx="90" cy="85" rx="5.5" ry="6" fill="#3d2b1f"/>
                <circle cx="91" cy="84" r="2.5" fill="black"/>
                <circle cx="93" cy="82" r="1.5" fill="white"/>
                <path d="M64 105 Q75 115 86 105" stroke="#c96b5a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <path d="M33 72 Q35 50 55 42 Q68 38 75 40 Q82 38 95 42 Q115 50 117 72 Q110 62 95 58 Q82 55 75 57 Q68 55 55 58 Q40 62 33 72Z" fill="#5a3825"/>
                <ellipse cx="75" cy="52" rx="45" ry="22" fill="#5c6b3c"/>
                <path d="M30 52 Q30 38 50 33 Q68 28 80 30 Q100 33 115 42 Q120 48 120 52" fill="#5c6b3c"/>
                <circle cx="48" cy="46" r="5" fill="#8b9a5c" stroke="#6b7a4c" stroke-width="1"/>
            </g>
        </svg>
        <div class="header-text">
            <h1>תשאל את מיכל</h1>
            <small id="userName"></small>
        </div>
        <div class="header-actions">
            <span class="quota-badge" id="quota"></span>
            <button class="header-btn" onclick="logout()" title="התנתקות">&#x2716;</button>
        </div>
    </div>

    <div class="michal-area" id="michalArea">
        <div class="michal-char">
            <svg viewBox="0 0 150 180" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g class="char-body" id="michalBody">
                    <ellipse cx="75" cy="82" rx="52" ry="50" fill="#5a3825"/>
                    <path d="M30 95 Q25 130 45 155" stroke="#5a3825" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M120 95 Q125 130 105 155" stroke="#5a3825" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <rect x="63" y="125" width="24" height="14" rx="4" fill="#fdd0a8"/>
                    <path d="M40 138 Q42 132 63 132 L87 132 Q108 132 110 138 L115 170 Q115 178 105 178 L45 178 Q35 178 35 170 Z" fill="#5c6b3c"/>
                    <path d="M63 132 L75 145 L87 132" fill="#4a5a30" stroke="#4a5a30" stroke-width="1"/>
                    <rect x="52" y="152" width="16" height="12" rx="2" fill="none" stroke="#4a5a30" stroke-width="1.5"/>
                    <rect x="82" y="152" width="16" height="12" rx="2" fill="none" stroke="#4a5a30" stroke-width="1.5"/>
                    <circle cx="75" cy="150" r="2" fill="#4a5a30"/>
                    <circle cx="75" cy="162" r="2" fill="#4a5a30"/>
                    <ellipse cx="75" cy="88" rx="42" ry="40" fill="#fdd0a8"/>
                    <ellipse cx="50" cy="98" rx="8" ry="4" fill="rgba(255,150,130,0.3)"/>
                    <ellipse cx="100" cy="98" rx="8" ry="4" fill="rgba(255,150,130,0.3)"/>
                    <g>
                        <ellipse cx="60" cy="85" rx="8" ry="9" fill="white"/>
                        <ellipse cx="60" cy="85" rx="5.5" ry="6" fill="#3d2b1f"/>
                        <circle class="pupil" cx="61" cy="84" r="2.5" fill="black"/>
                        <circle cx="63" cy="82" r="1.5" fill="white"/>
                        <ellipse class="eye-lid" cx="60" cy="85" rx="9" ry="10" fill="#fdd0a8"/>
                    </g>
                    <g>
                        <ellipse cx="90" cy="85" rx="8" ry="9" fill="white"/>
                        <ellipse cx="90" cy="85" rx="5.5" ry="6" fill="#3d2b1f"/>
                        <circle class="pupil" cx="91" cy="84" r="2.5" fill="black"/>
                        <circle cx="93" cy="82" r="1.5" fill="white"/>
                        <ellipse class="eye-lid" cx="90" cy="85" rx="9" ry="10" fill="#fdd0a8"/>
                    </g>
                    <path d="M52 74 Q60 70 68 73" stroke="#4a3020" stroke-width="2" stroke-linecap="round" fill="none"/>
                    <path d="M82 73 Q90 70 98 74" stroke="#4a3020" stroke-width="2" stroke-linecap="round" fill="none"/>
                    <path d="M73 94 Q75 97 77 94" stroke="#e8a878" stroke-width="1.5" stroke-linecap="round" fill="none"/>
                    <path class="mouth-smile" id="mouth" d="M64 105 Q75 115 86 105" stroke="#c96b5a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                    <path d="M33 72 Q35 50 55 42 Q68 38 75 40 Q82 38 95 42 Q115 50 117 72 Q110 62 95 58 Q82 55 75 57 Q68 55 55 58 Q40 62 33 72Z" fill="#5a3825"/>
                    <ellipse cx="75" cy="52" rx="45" ry="22" fill="#5c6b3c"/>
                    <path d="M30 52 Q30 38 50 33 Q68 28 80 30 Q100 33 115 42 Q120 48 120 52" fill="#5c6b3c"/>
                    <path d="M105 42 Q112 38 118 44" stroke="#4a5a30" stroke-width="1.5" fill="none"/>
                    <circle cx="48" cy="46" r="5" fill="#8b9a5c" stroke="#6b7a4c" stroke-width="1"/>
                    <path d="M46 46 L48 43 L50 46 L48 49Z" fill="#6b7a4c"/>
                    <rect x="42" y="138" width="8" height="3" rx="1" fill="#8b9a5c"/>
                    <rect x="100" y="138" width="8" height="3" rx="1" fill="#8b9a5c"/>
                </g>
            </svg>
        </div>
        <div class="michal-status" id="michalStatus">מוכנה לעזור!</div>
    </div>

    <div class="messages" id="messages">
        <div class="msg bot">שלום! אני מיכל, משקית שלישות וירטואלית. איך אוכל לעזור לך היום?</div>
    </div>

    <div class="input-area">
        <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="uploadPDF()">
        <button class="action-btn upload-btn" onclick="document.getElementById('fileInput').click()" title="העלאת PDF">&#128206;</button>
        <div class="input-wrap">
            <textarea id="input" rows="1" placeholder="...שאלי את מיכל"></textarea>
        </div>
        <button class="action-btn send-btn" id="sendBtn" onclick="send()" title="שליחה">&#10148;</button>
    </div>

    <script>
        const token = localStorage.getItem('michal_token');
        const userName = localStorage.getItem('michal_user');
        if (!token) window.location.href = '/';

        document.getElementById('userName').textContent = userName || '';

        fetch('/api/quota', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(r => r.json())
            .then(d => { document.getElementById('quota').textContent = d.queries_remaining + ' שאלות'; })
            .catch(() => {});

        const input = document.getElementById('input');
        const messagesDiv = document.getElementById('messages');
        const sendBtn = document.getElementById('sendBtn');
        const michalBody = document.getElementById('michalBody');
        const michalStatus = document.getElementById('michalStatus');
        const michalArea = document.getElementById('michalArea');
        const mouth = document.getElementById('mouth');

        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
        });

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                e.preventDefault();
                send();
            }
        });

        let messageCount = 0;

        function setMood(mood, status) {
            michalBody.className = 'char-body ' + mood;
            michalStatus.textContent = status;
            if (mood === 'thinking') {
                mouth.setAttribute('d', 'M68 105 Q75 108 82 105');
            } else if (mood === 'happy') {
                mouth.setAttribute('d', 'M62 103 Q75 118 88 103');
            } else {
                mouth.setAttribute('d', 'M64 105 Q75 115 86 105');
            }
        }

        function addMessage(text, type, sources) {
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            div.textContent = text;
            if (sources && sources.length > 0) {
                const srcDiv = document.createElement('div');
                srcDiv.className = 'sources';
                srcDiv.textContent = sources.join(' | ');
                div.appendChild(srcDiv);
            }
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            messageCount++;
            if (messageCount >= 2) michalArea.classList.add('compact');
        }

        async function send() {
            const q = input.value.trim();
            if (!q) return;
            addMessage(q, 'user');
            input.value = '';
            input.style.height = 'auto';
            sendBtn.disabled = true;
            setMood('thinking', '...חושבת');

            try {
                const res = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ question: q })
                });
                if (res.status === 401) { window.location.href = '/'; return; }
                if (res.status === 429) {
                    setMood('', 'מכסת השאלות נגמרה');
                    addMessage('מכסת השאלות שלך נגמרה. לקבלת שאלות נוספות פנה/י למנהל המערכת: bar@yae.la', 'system');
                    return;
                }
                const data = await res.json();
                if (res.ok) {
                    setMood('happy', 'שמחה לעזור!');
                    addMessage(data.answer, 'bot', data.sources);
                    document.getElementById('quota').textContent = data.queries_remaining + ' שאלות';
                    setTimeout(() => setMood('', 'מוכנה לעזור!'), 3000);
                } else {
                    setMood('', 'אופס...');
                    addMessage(data.detail || 'שגיאה בלתי צפויה', 'system');
                }
            } catch (err) {
                setMood('', 'שגיאת תקשורת');
                addMessage('שגיאת תקשורת. נסה/י שנית.', 'system');
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        async function uploadPDF() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;
            setMood('thinking', '...קוראת את המסמך');
            addMessage('מעלה את ' + file.name + '...', 'system');
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                const data = await res.json();
                if (res.ok) {
                    setMood('happy', 'למדתי מסמך חדש!');
                    addMessage('הקובץ ' + file.name + ' הועלה בהצלחה! (' + data.chunks + ' קטעים חדשים)', 'system success');
                    setTimeout(() => setMood('', 'מוכנה לעזור!'), 3000);
                } else {
                    setMood('', 'שגיאה');
                    addMessage(data.detail || 'שגיאה בהעלאת הקובץ', 'system');
                }
            } catch (err) {
                setMood('', 'שגיאת תקשורת');
                addMessage('שגיאת תקשורת בהעלאת הקובץ', 'system');
            }
            fileInput.value = '';
        }

        function logout() {
            localStorage.removeItem('michal_token');
            localStorage.removeItem('michal_user');
            window.location.href = '/';
        }

        setTimeout(() => input.focus(), 300);
    </script>
</body>
</html>
